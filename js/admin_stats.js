// static/admin_dashboard.js

const chartInstances = {};  // canvasId ‚Üí Chart Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•Ïö©

document.addEventListener("DOMContentLoaded", () => {
    // const today = new Date();
    // const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    // const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  
    // document.getElementById("startDate").value = firstDay.toISOString().slice(0, 10);
    // document.getElementById("endDate").value = lastDay.toISOString().slice(0, 10);
  
    setDefaultDateRange();
    loadStats();
    loadGraphData(); // ‚úÖ Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞Î•º ÏöîÏ≤≠
    loadDeptStats();
    setDefaultWeeklyDate(); 
    loadWeeklyDeptStats();
  });
  
// ‚úÖ ÌÜµÍ≥Ñ Ï°∞Ìöå Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
function loadStats() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    getData(`/admin/stats/period?start=${start}&end=${end}`, renderStats, (err) => {
        console.error("‚ùå ÌÜµÍ≥Ñ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
        alert("‚ùå ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÏΩòÏÜî ÌôïÏù∏ Î∞îÎûçÎãàÎã§.");
    });
}
  
function renderStats(data) {
    const tbody = document.getElementById("stats-body");
    tbody.innerHTML = "";

    const weekGroups = {};  // ‚úÖ Ï£ºÍ∞Ñ Îã®ÏúÑÎ°ú Í∑∏Î£πÌôî
    let monthlyTotal = { breakfast: 0, lunch: 0, dinner: 0 };

    // ‚úÖ Ï£ºÍ∞Ñ Îã®ÏúÑÎ°ú Í∑∏Î£π ÎÇòÎàÑÍ∏∞
    data.forEach(row => {
        const weekKey = getWeekKey(row.date);
        if (!weekGroups[weekKey]) {
            weekGroups[weekKey] = [];
        }
        weekGroups[weekKey].push(row);

        // ÏõîÍ∞Ñ ÎàÑÏ†Å
        monthlyTotal.breakfast += row.breakfast;
        monthlyTotal.lunch += row.lunch;
        monthlyTotal.dinner += row.dinner;
    });

    // ‚úÖ Ï£ºÍ∞ÑÎ≥ÑÎ°ú Ï∂úÎ†• Î∞è ÏÜåÍ≥Ñ
    for (const [weekKey, rows] of Object.entries(weekGroups)) {
        rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.className = "normal-row";
            tr.innerHTML = `
                <td>${row.date}</td>
                <td>${row.day}</td>
                <td>${row.breakfast}</td>
                <td>${row.lunch}</td>
                <td>${row.dinner}</td>
            `;
            tbody.appendChild(tr);
        });

        // ‚úÖ Ï£ºÍ∞Ñ ÏÜåÍ≥Ñ
        const subtotal = rows.reduce((sum, r) => {
            sum.breakfast += r.breakfast;
            sum.lunch += r.lunch;
            sum.dinner += r.dinner;
            return sum;
        }, { breakfast: 0, lunch: 0, dinner: 0 });

        const subtotalRow = document.createElement("tr");
        subtotalRow.className = "subtotal-row";
        subtotalRow.innerHTML = `
            <td colspan="2">${weekKey} ÏÜåÍ≥Ñ</td>
            <td>${subtotal.breakfast}</td>
            <td>${subtotal.lunch}</td>
            <td>${subtotal.dinner}</td>
        `;
        tbody.appendChild(subtotalRow);
    }

    // ‚úÖ Ï¥ùÍ≥Ñ
    const totalRow = document.createElement("tr");
    totalRow.className = "total-row";
    totalRow.innerHTML = `
        <td colspan="2">Í∏∞Í∞ÑÎ≥Ñ Ï¥ùÍ≥Ñ</td>
        <td>${monthlyTotal.breakfast}</td>
        <td>${monthlyTotal.lunch}</td>
        <td>${monthlyTotal.dinner}</td>
    `;
    tbody.appendChild(totalRow);
}
  
  // Ï£ºÏ∞® key ÏÉùÏÑ± Ìï®Ïàò
function getWeekKey(dateStr) {
    const date = new Date(dateStr);
    const year = date.getFullYear();

    // Ï£ºÏ∞® Í≥ÑÏÇ∞: ISO Ï£ºÏ∞® Í∏∞Ï§Ä (Ï£º ÏãúÏûëÏùÄ ÏõîÏöîÏùº)
    const jan4 = new Date(year, 0, 4);  // 1Ïõî 4Ïùº (Ìï≠ÏÉÅ 1Ï£ºÏ∞® Ìè¨Ìï®)
    const dayOfWeek = jan4.getDay() || 7;  // ÏùºÏöîÏùº 0 ‚Üí 7 Ï≤òÎ¶¨
    const week1Start = new Date(jan4);
    week1Start.setDate(jan4.getDate() - dayOfWeek + 1);  // 1Ï£ºÏ∞®Ïùò ÏõîÏöîÏùº

    const diff = (date - week1Start) / (1000 * 60 * 60 * 24);
    const weekNo = Math.floor(diff / 7) + 1;

    return `${year}-${weekNo.toString().padStart(2, '0')}Ï£ºÏ∞®`;
}

  // ‚úÖ Í∏∞Î≥∏ ÎÇ†ÏßúÎ•º "Ïù¥Î≤à Îã¨ 1Ïùº ~ ÎßêÏùº"Î°ú ÏÑ§Ï†ï
function setDefaultDateRange() {
    const now = getKSTDate();
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);

    const format = (date) => {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const dd = String(date.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
    };

    document.getElementById("startDate").value = format(first);
    document.getElementById("endDate").value = format(last);
}
  
function downloadStatsExcel() {
    showToast("üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ÄÎπÑ Ï§ë...");
    window.location.href = `${API_BASE_URL}/admin/stats/period/excel?start=${startDate.value}&end=${endDate.value}`;
}


// üìä Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞Ïö© Ìï®Ïàò
function loadGraphData() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
  
    getData(`/admin/graph/week_trend?start=${start}&end=${end}`, (rawData) => {
    
        const data = groupDataByWeekAndMeal(rawData);  // ‚úÖ Ïù¥Í±∏ Îπ†Îú®Î†∏ÏóàÏùå
        drawLineGraph("graph-week-current", data.weekCurrent, "Í∏àÏ£º Ïã†Ï≤≠ Ï∂îÏù¥");
        drawLineGraph("graph-week-next", data.weekNext, "Ï∞®Ï£º Ïã†Ï≤≠ Ï∂îÏù¥");
        drawLineGraph("graph-dow-average", data.dowAvg, "ÏöîÏùºÎ≥Ñ ÌèâÍ∑† Ïã†Ï≤≠");
        drawLineGraph("graph-weekly-trend", data.weekTrend, "Ï£ºÍ∞ÑÎ≥Ñ Ïã†Ï≤≠ Ìä∏Î†åÎìú");
    }, (err) => {
      console.error("‚ùå Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞ Ïã§Ìå®:", err);
      alert("‚ùå Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    });
}
  
  // üìà Í∫æÏùÄÏÑ† Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞
function drawLineGraph(canvasId, data, title) {
    const ctx = document.getElementById(canvasId).getContext("2d");

    const labels = data.labels || [];
    const breakfast = data.breakfast || [];
    const lunch = data.lunch || [];
    const dinner = data.dinner || [];

    // ‚úÖ Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞ (ÌïÑÏàò!)
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: "ÏïÑÏπ®",
            data: breakfast,
            borderWidth: 2,
            fill: false
          },
          {
            label: "Ï†êÏã¨",
            data: lunch ,
            borderWidth: 2,
            fill: false
          },
          {
            label: "Ï†ÄÎÖÅ",
            data: dinner,
            borderWidth: 2,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: title,
                font: {
                   size: 40,
                }
            },
            tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.formattedValue}`;
                  }
                }
            },
            legend: {
                position: 'right',
                labels: {
                  font: {
                    size: 20  // ‚úÖ Î≤îÎ°Ä ÌÖçÏä§Ìä∏ ÌÅ¨Í≤å
                  }
                }
            },
            datalabels: {
                color: '#000',
                anchor: 'end',
                align: 'top',
                font: {
                    weight: 'bold',
                    size: 20
                },
                formatter: (value) => value
            }
            
        },
        scales: {
            x: {
                ticks: {
                  font: {
                    size: 20  // ‚úÖ XÏ∂ï Í∏ÄÏûê
                  }
                }
            },
            y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: {
                    size: 25  // ‚úÖ YÏ∂ï Í∏ÄÏûê
                  }
                }
            }
        }
      },
      plugins: [ChartDataLabels]  // ‚úÖ ÌïÑÏàò
      
    });

    // ‚úÖ ÏÉùÏÑ±Îêú Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§Î•º Ï†ÄÏû•
    chartInstances[canvasId] = chart;
}

function groupDataByWeekAndMeal(rawData) {
    const weekCurrent = {
        labels: ["Ïõî", "Ìôî", "Ïàò", "Î™©", "Í∏à"],
        breakfast: [0, 0, 0, 0, 0],
        lunch: [0, 0, 0, 0, 0],
        dinner: [0, 0, 0, 0, 0]
      };
      
      const weekNext = {
        labels: ["Ïõî", "Ìôî", "Ïàò", "Î™©", "Í∏à"],
        breakfast: [0, 0, 0, 0, 0],
        lunch: [0, 0, 0, 0, 0],
        dinner: [0, 0, 0, 0, 0]
      };


    const dowAvg = { labels: ["Ïõî", "Ìôî", "Ïàò", "Î™©", "Í∏à"], breakfast: [0,0,0,0,0], lunch: [0,0,0,0,0], dinner: [0,0,0,0,0], count: [0,0,0,0,0] };
    
    
    const today = getKSTDate();
    const monday = getMonday(today);
    const nextMonday = new Date(monday);
    nextMonday.setDate(monday.getDate() + 7);

    const weekGroup = {};  // Ï£ºÏ∞®Î≥Ñ Î¨∂Ïùå
    const dateSet = new Set(); // ‚úÖ [Ï∂îÍ∞Ä] Ï†ÑÏ≤¥ ÎÇ†Ïßú ÏàòÏßëÏö©

    rawData.forEach(row => {
        const date = new Date(row.label);
        const dow = parseInt(row.weekday); // 0=Ïùº ~ 6=ÌÜ†

        dateSet.add(row.label); // ‚úÖ [Ï∂îÍ∞Ä] Ï†ÑÏ≤¥ ÎÇ†Ïßú Í∏∞Î°ù

        if (dow >= 1 && dow <= 5) {
            const idx = dow - 1;

            // Í∏àÏ£º
            if (isInWeek(date, monday)) {
                weekCurrent.labels[idx] = getDayLabel(dow);
                weekCurrent.breakfast[idx] = row.breakfast;
                weekCurrent.lunch[idx] = row.lunch;
                weekCurrent.dinner[idx] = row.dinner;
            }

            // Ï∞®Ï£º
            if (isInWeek(date, nextMonday)) {
                weekNext.labels[idx] = getDayLabel(dow);
                weekNext.breakfast[idx] = row.breakfast;
                weekNext.lunch[idx] = row.lunch;
                weekNext.dinner[idx] = row.dinner;
            }

            // ÏöîÏùº ÌèâÍ∑†
            dowAvg.breakfast[idx] += row.breakfast;
            dowAvg.lunch[idx] += row.lunch;
            dowAvg.dinner[idx] += row.dinner;
            dowAvg.count[idx]++;
        }

        // Ï£ºÍ∞Ñ Ìä∏Î†åÎìú
        const weekKey = getYearWeek(date);
        if (!weekGroup[weekKey]) {
            weekGroup[weekKey] = { breakfast: 0, lunch: 0, dinner: 0 };
        }
        weekGroup[weekKey].breakfast += row.breakfast;
        weekGroup[weekKey].lunch += row.lunch;
        weekGroup[weekKey].dinner += row.dinner;
    });

    // ÏöîÏùº ÌèâÍ∑† Í≥ÑÏÇ∞
    const dowAverageResult = { labels: dowAvg.labels, breakfast: [], lunch: [], dinner: [] };

    for (let i = 0; i < 5; i++) {
        dowAverageResult.breakfast.push(dowAvg.count[i] ? Math.round(dowAvg.breakfast[i] / dowAvg.count[i]) : 0);
        dowAverageResult.lunch.push(dowAvg.count[i] ? Math.round(dowAvg.lunch[i] / dowAvg.count[i]) : 0);
        dowAverageResult.dinner.push(dowAvg.count[i] ? Math.round(dowAvg.dinner[i] / dowAvg.count[i]) : 0);
    }

     // ‚úÖ [ÏàòÏ†ï ÏãúÏûë] Îπ†ÏßÑ Ï£ºÏ∞® Î≥¥Ï†ï Ìè¨Ìï®Ìïú Ï£ºÍ∞Ñ Ìä∏Î†åÎìú Ï≤òÎ¶¨
    const weekTrend = { labels: [], breakfast: [], lunch: [], dinner: [] };


    const weekKeysSet = new Set();
    if (dateSet.size > 0) {
        const sortedDates = Array.from(dateSet).sort();
        const startDate = new Date(sortedDates[0]);
        const endDate = new Date(sortedDates[sortedDates.length - 1]);

        let current = new Date(getMonday(startDate));
        const end = new Date(getMonday(endDate));
        end.setDate(end.getDate() + 7); // ÎßàÏßÄÎßâ Ï£º Ìè¨Ìï®

        while (current <= end) {
            const weekKey = getYearWeek(current);
            weekKeysSet.add(weekKey);
            current.setDate(current.getDate() + 7); // Îã§Ïùå Ï£º
        }
    }

    const allWeeks = Array.from(weekKeysSet).sort();
    allWeeks.forEach(weekKey => {
        const entry = weekGroup[weekKey] || { breakfast: 0, lunch: 0, dinner: 0 };
        weekTrend.labels.push(weekKey);
        weekTrend.breakfast.push(entry.breakfast);
        weekTrend.lunch.push(entry.lunch);
        weekTrend.dinner.push(entry.dinner);
    });
    // ‚úÖ [ÏàòÏ†ï ÎÅù]

    return {
        weekCurrent,
        weekNext,
        dowAvg: dowAverageResult,
        weekTrend
    };
}
  
// ÎÇ†Ïßú ‚Üí ÏöîÏùº Î≥ÄÌôò
function getDayLabel(day) {
    return ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][day];
}
  
// Ìï¥Îãπ ÎÇ†ÏßúÍ∞Ä Ìè¨Ìï®Îêú Ï£ºÏ∞® ÌëúÏãú (Ïòà: "2025-W14")
function getYearWeek(date) {
    const d = new Date(date.getTime());
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));
    const week1 = new Date(d.getFullYear(), 0, 4);
    const weekNum = Math.ceil((((d - week1) / 86400000) + 1) / 7);
    return `${d.getFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
}

function isInWeek(date, monday) {
    const start = new Date(monday);
    const end = new Date(monday);
    end.setDate(start.getDate() + 5);
    return date >= start && date < end;
}

function getMonday(d) {
    const date = new Date(d);
    const day = date.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    date.setDate(date.getDate() + diff);
    return new Date(date.getFullYear(), date.getMonth(), date.getDate());
}

function renderDeptStats(data) {
  const tbody = document.getElementById("dept-stats-body");
  tbody.innerHTML = "";

  const direct = [];
  const partner = [];
  const visitor = [];

  // ‚úÖ Î∂ÄÏÑúÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Î∂ÑÎ¶¨
  data.forEach(row => {
    const item = {
      dept: row.dept,
      breakfast: row.breakfast,
      lunch: row.lunch,
      dinner: row.dinner
    };
    if (row.type === "ÏßÅÏòÅ") {
      direct.push(item);
    } else if(row.type === "ÌòëÎ†•ÏÇ¨"){
      partner.push(item);
    } else{
      visitor.push(item);
    }

  });

  // ‚úÖ Ï†ïÎ†¨ Ìï®Ïàò
  const sortByDept = (a, b) => a.dept.localeCompare(b.dept);

  // ‚úÖ Ï∂úÎ†• Î∞è ÎàÑÏ†Å Ìï®Ïàò
  const renderRows = (rows, label) => {
    rows.sort(sortByDept).forEach(row => {
      const tr = document.createElement("tr");
      const total = row.breakfast + row.lunch + row.dinner;
      tr.innerHTML = `
        <td>${row.dept}</td>
        <td>${total}</td>
        <td>${row.breakfast}</td>
        <td>${row.lunch}</td>
        <td>${row.dinner}</td>
      `;
      tbody.appendChild(tr);
    });

    const subtotal = rows.reduce((sum, r) => ({
      breakfast: sum.breakfast + r.breakfast,
      lunch: sum.lunch + r.lunch,
      dinner: sum.dinner + r.dinner
    }), { breakfast: 0, lunch: 0, dinner: 0 });

    const tr = document.createElement("tr");
    tr.className = "subtotal-row";
    const total = subtotal.breakfast + subtotal.lunch + subtotal.dinner;
    tr.innerHTML = `
      <td>${label} ÏÜåÍ≥Ñ</td>
      <td>${total}</td>
      <td>${subtotal.breakfast}</td>
      <td>${subtotal.lunch}</td>
      <td>${subtotal.dinner}</td>
    `;
    tbody.appendChild(tr);

    return subtotal;
  };

  // ‚úÖ Î†åÎçîÎßÅ ÏàúÏÑúÎåÄÎ°ú Ïã§Ìñâ
  const subDirect = renderRows(direct, "ÏßÅÏòÅ");
  const subPartner = renderRows(partner, "ÌòëÎ†•ÏÇ¨");
  const subVisitor = renderRows(visitor, "Î∞©Î¨∏Ïûê");

  // ‚úÖ Ï¥ùÍ≥Ñ
  const tr = document.createElement("tr");
  tr.className = "total-row";
  const total = subDirect.breakfast + subPartner.breakfast + subVisitor.breakfast +
                subDirect.lunch + subPartner.lunch + subVisitor.lunch +
                subDirect.dinner + subPartner.dinner + subVisitor.dinner;

  tr.innerHTML = `
    <td>Ï¥ùÍ≥Ñ</td>
    <td>${total}</td>
    <td>${subDirect.breakfast + subPartner.breakfast + subVisitor.breakfast}</td>
    <td>${subDirect.lunch + subPartner.lunch + subVisitor.lunch}</td>
    <td>${subDirect.dinner + subPartner.dinner + subVisitor.dinner}</td>
  `;
  tbody.appendChild(tr);
}

// ‚úÖ Î∂ÄÏÑúÎ≥Ñ Ïã†Ï≤≠ÌòÑÌô© Î°úÎî© Ìï®Ïàò (htmlÏùò Î≤ÑÌäºÏóêÏÑú Ìò∏Ï∂úÎê®)
function loadDeptStats() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  if (!start || !end) {
    alert("ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
    return;
  }

  getData(`/admin/stats/dept_summary?start=${start}&end=${end}`, renderDeptStats, (err) => {
    console.error("‚ùå Î∂ÄÏÑúÎ≥Ñ Ïã†Ï≤≠ÌòÑÌô© Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
    alert("‚ùå Î∂ÄÏÑúÎ≥Ñ Ïã†Ï≤≠ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
  });
}

function downloadDeptStatsExcel() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  showToast("üì• Î∂ÄÏÑúÎ≥Ñ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ÄÎπÑ Ï§ë...");
  window.location.href = `${API_BASE_URL}/admin/stats/dept_summary/excel?start=${start}&end=${end}`;
}


function loadWeeklyDeptStats() {
  const base = document.getElementById("weeklyBaseDate").value;
  if (!base) return alert("Í∏∞Ï§Ä ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");

  const range = getWeeklyDateRange(base); // ‚úÖ Ïõî~Í∏à ÎÇ†Ïßú Î∞∞Ïó¥ Î∞òÌôò

  const start = range[0];
  const end = range[range.length - 1];
 

  // ÏãùÏàò Ïã†Ï≤≠ + Í≥µÌú¥Ïùº Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
  getData(`/admin/stats/weekly_dept?start=${start}&end=${end}`, (mealData) => {
    
    const year = new Date(start).getFullYear();  // ‚úÖ ÏãúÏûë ÎÇ†Ïßú Í∏∞Ï§Ä Ïó∞ÎèÑ Ï∂îÏ∂ú

    fetchHolidayList(`/holidays?year=${year}`, (holidayData) => {
      const holidayDates = holidayData;  // ‚úÖ ['2025-04-10', ...]
      console.log("üîç Í≥µÌú¥Ïùº Î™©Î°ù:", holidayDates);  // ‚úÖ ÏΩòÏÜî ÌôïÏù∏Ïö©
      console.log("üîç Í≥µÌú¥Ïùº ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞:", holidayData);
      renderWeeklyDeptStats(mealData, holidayDates, range);  // ‚úÖ Í≥µÌú¥Ïùº Ï†ïÎ≥¥ ÎÑòÍπÄ
    });
  }, (err) => {
    console.error("‚ùå Ï£ºÍ∞Ñ ÌòÑÌô© Ï°∞Ìöå Ïã§Ìå®:", err);
    alert("‚ùå Ï£ºÍ∞Ñ ÌòÑÌô© Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
  });
}

function getWeeklyDateRange(dateStr) {
  const base = new Date(dateStr);
  const day = base.getDay(); // 0(Ïùº)~6(ÌÜ†)
  const monday = new Date(base);
  monday.setDate(base.getDate() - ((day + 6) % 7)); // ÏõîÏöîÏùº

  const result = [];
  for (let i = 0; i < 5; i++) {
    const d = new Date(monday);
    d.setDate(d.getDate() + i);
    result.push(d.toISOString().slice(0, 10));
  }
  return result;
}

// function renderWeeklyDeptStats(data, holidays, range) {
//   const tbody = document.getElementById("weekly-dept-body");
//   const thead = document.getElementById("weekly-dept-thead");
//   tbody.innerHTML = "";
//   thead.innerHTML = "";

//   createWeeklyTableHeaders(range, holidays);

//   const direct = [], partner = [], visitor = [];

//   // ‚úÖ 1. ÌÉÄÏûÖÎ≥ÑÎ°ú Íµ¨Î∂Ñ
//   data.forEach(item => {
//     if (item.type === "ÏßÅÏòÅ") direct.push(item);
//     else if (item.type === "ÌòëÎ†•ÏÇ¨") partner.push(item);
//     else visitor.push(item);
//   });

//   // ‚úÖ 2. ÏãùÏàò ÏàòÎüâ Ï∂îÏ∂ú
//   function extractQuantity(name) {
//     const match = name.match(/\((\d+)\)$/);
//     return match ? parseInt(match[1]) : 1;
//   }

//   // ‚úÖ 3. Ìñâ Î†åÎçîÎßÅ
//   function processRows(rows) {
//     const sums = range.map(() => ({ b: 0, l: 0, d: 0 }));

//     rows.sort((a, b) => a.dept.localeCompare(b.dept)).forEach(row => {
//       const tr = document.createElement("tr");

//       // ‚úÖ Î∞©Î¨∏Ïûê/ÌòëÎ†•ÏÇ¨ ‚Üí Ï¥ùÌï© / ÏßÅÏòÅ ‚Üí Ïù∏ÏõêÏàò
//       const totalCount = row.type === "ÏßÅÏòÅ"
//         ? row.total
//         : range.reduce((sum, date) => {
//             const meals = row.days[date] || { b: [], l: [], d: [] };
//             return sum +
//               meals.b.reduce((s, n) => s + extractQuantity(n), 0) +
//               meals.l.reduce((s, n) => s + extractQuantity(n), 0) +
//               meals.d.reduce((s, n) => s + extractQuantity(n), 0);
//           }, 0);

//         // ‚úÖ Ï°∞Ïãù: Ïù∏Ïõê + Î™ÖÎã®
//       tr.innerHTML = `
//         <td class="weekly-dept-cell">${row.dept}</td>
//         <td class="weekly-count-cell">${totalCount}</td>
//       `;
//       range.forEach((date, i) => {
//         const v = row.days[date] || { b: [], l: [], d: [] };

//         const bQty = v.b.reduce((acc, name) => acc + extractQuantity(name), 0);
//         const lQty = v.l.reduce((acc, name) => acc + extractQuantity(name), 0);
//         const dQty = v.d.reduce((acc, name) => acc + extractQuantity(name), 0);

//         sums[i].b += bQty;
//         sums[i].l += lQty;
//         sums[i].d += dQty;

//         // ‚úÖ Ï°∞Ïãù
//         tr.innerHTML += `
//           <td class="weekly-count-cell">${bQty}</td>
//           <td class="weekly-name-cell">${v.b.join(", ") || "-"}</td>
//         `;
//         // ‚úÖ Ï§ëÏãù
//         tr.innerHTML += `<td class="weekly-count-cell">${lQty}</td>`;
//         // ‚úÖ ÏÑùÏãù
//         tr.innerHTML += `
//           <td class="weekly-count-cell">${dQty}</td>
//           <td class="weekly-name-cell">${v.d.join(", ") || "-"}</td>
//         `;
//       });

//       tbody.appendChild(tr);
//     });

//     return sums;
//   }

//   // ‚úÖ Ï∂úÎ†• ÏàúÏÑú Î∞è ÏöîÏïΩ Ìñâ Ï∂îÍ∞Ä
//   const directSums = processRows(direct);
//   appendSummaryRow("ÏßÅÏòÅ ÏÜåÍ≥Ñ", directSums, tbody);

//   const partnerSums = processRows(partner);
//   appendSummaryRow("ÌòëÎ†•ÏÇ¨ ÏÜåÍ≥Ñ", partnerSums, tbody);

//   const visitorSums = processRows(visitor);
//   appendSummaryRow("Î∞©Î¨∏Ïûê ÏÜåÍ≥Ñ", visitorSums, tbody);

//   const totalSums = range.map((_, i) => ({
//     b: directSums[i].b + partnerSums[i].b + visitorSums[i].b,
//     l: directSums[i].l + partnerSums[i].l + visitorSums[i].l,
//     d: directSums[i].d + partnerSums[i].d + visitorSums[i].d
//   }));

//   appendSummaryRow("Ï¥ùÍ≥Ñ", totalSums, tbody, true);
// }

// ‚úÖ Ïú†Ìã∏: Ïù¥Î¶Ñ(3)ÏóêÏÑú Ïà´Ïûê 3 Ï∂îÏ∂ú
function extractQuantity(name) {
  const match = name.match(/\((\d+)\)$/);
  return match ? parseInt(match[1]) : 1;
}

// ‚úÖ ÌïµÏã¨ Î†åÎçîÎßÅ Ìï®Ïàò
function renderWeeklyDeptStats(data, holidays, range) {
  const tbody = document.getElementById("weekly-dept-body");
  const thead = document.getElementById("weekly-dept-thead");
  tbody.innerHTML = "";
  thead.innerHTML = "";

  // ‚úÖ Í≥µÌú¥Ïùº Ìè¨Ìï®Ìïú 3Ìñâ Ìó§Îçî ÏÉùÏÑ±
  createWeeklyTableHeaders(range, holidays);

  // ‚úÖ Î∂ÄÏÑú Ïú†Ìòï Î∂ÑÎ•ò
  const direct = [], directTrip = [], partner = [], visitor = [];

  data.forEach(row => {
    if (row.type === "ÏßÅÏòÅ" && row.dept.includes("(Ï∂úÏû•)")) {
      directTrip.push(row);
    } else if (row.type === "ÏßÅÏòÅ") {
      direct.push(row);
    } else if (row.type === "ÌòëÎ†•ÏÇ¨") {
      partner.push(row);
    } else {
      visitor.push(row);
    }
  });


  // ‚úÖ Ïã§Ï†ú ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ Ìï®Ïàò
  function processRows(rows) {
    const sums = range.map(() => ({ b: 0, l: 0, d: 0 }));

    rows.sort((a, b) => a.dept.localeCompare(b.dept)).forEach(row => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="weekly-dept-cell">${row.display_dept || row.dept}</td>
        <td class="weekly-count-cell">${row.total || 0}</td>
      `;

      range.forEach((date, i) => {
        const isHoliday = holidays.includes(date);
        const style = isHoliday ? ' style="background-color:#ffe6e6"' : '';

        const v = row.days[date] || { b: [], l: [], d: [] };

        const bQty = v.b.reduce((acc, n) => acc + extractQuantity(n), 0);
        const lQty = v.l.reduce((acc, n) => acc + extractQuantity(n), 0);
        const dQty = v.d.reduce((acc, n) => acc + extractQuantity(n), 0);

        sums[i].b += bQty;
        sums[i].l += lQty;
        sums[i].d += dQty;

        const bNames = v.b.length ? v.b.join(", ") : "-";
        const dNames = v.d.length ? v.d.join(", ") : "-";

        tr.innerHTML += `
          <td class="weekly-count-cell"${style}>${bQty}</td>
          <td class="weekly-name-cell"${style}>${bNames}</td>
          <td class="weekly-count-cell"${style}>${lQty}</td>
          <td class="weekly-count-cell"${style}>${dQty}</td>
          <td class="weekly-name-cell"${style}>${dNames}</td>
        `;
      });

      tbody.appendChild(tr);
    });

    return sums;
  }

  // ‚úÖ ÏßÅÏòÅ Ï∂úÎ†•
  const sum1 = processRows(direct);
  appendSummaryRow("ÏßÅÏòÅ ÏÜåÍ≥Ñ", sum1, tbody);

  const sum1_trip = processRows(directTrip);
  if (sum1_trip.length > 0) {
    appendSummaryRow("ÏßÅÏòÅ(Ï∂úÏû•Ïûê)", sum1_trip, tbody);
  }

  // ‚úÖ ÌòëÎ†•ÏÇ¨ Ï∂úÎ†•
  const sum2 = processRows(partner);
  appendSummaryRow("ÌòëÎ†•ÏÇ¨ ÏÜåÍ≥Ñ", sum2, tbody);

  // ‚úÖ Î∞©Î¨∏Ïûê Ï∂úÎ†•
  const sum3 = processRows(visitor);
  appendSummaryRow("Î∞©Î¨∏Ïûê ÏÜåÍ≥Ñ", sum3, tbody);

  // ‚úÖ Ï¥ùÍ≥Ñ Ï∂úÎ†•
  const totalSums = range.map((_, i) => ({
    b: sum1[i].b + sum1_trip[i].b + sum2[i].b + sum3[i].b,
    l: sum1[i].l + sum1_trip[i].l + sum2[i].l + sum3[i].l,
    d: sum1[i].d + sum1_trip[i].d + sum2[i].d + sum3[i].d
  }));
  appendSummaryRow("Ï¥ùÍ≥Ñ", totalSums, tbody, true);
}


function createWeeklyTableHeaders(range, holidays) {
  const thead = document.getElementById("weekly-dept-thead");
  const isHoliday = d => holidays.includes(d);

  const tr1 = document.createElement("tr");
  const tr2 = document.createElement("tr");
  const tr3 = document.createElement("tr");

  tr1.innerHTML = `<th rowspan="3">Î∂ÄÏÑú</th><th rowspan="3">ÌòÑ Ïù∏ÏõêÏàò</th>`;
  tr2.innerHTML = "";
  tr3.innerHTML = "";

  range.forEach(d => {
    const date = new Date(d);
    const label = `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº (${["Ïùº","Ïõî","Ìôî","Ïàò","Î™©","Í∏à","ÌÜ†"][date.getDay()]})`;
    
    const holidayClass = isHoliday(d) ? ' class="holiday-header"' : '';
    tr1.innerHTML += `<th colspan="5"${holidayClass}>${label}</th>`;

    tr2.innerHTML += `
      <th colspan="2"${holidayClass}>Ï°∞Ïãù</th>
      <th${holidayClass}>Ï§ëÏãù</th>
      <th colspan="2"${holidayClass}>ÏÑùÏãù</th>
    `;
    tr3.innerHTML += `
      <th${holidayClass}>Ïù∏Ïõê</th><th${holidayClass}>Î™ÖÎã®</th>
      <th${holidayClass}>Ïù∏Ïõê</th>
      <th${holidayClass}>Ïù∏Ïõê</th><th${holidayClass}>Î™ÖÎã®</th>
    `;
  });

  thead.appendChild(tr1);
  thead.appendChild(tr2);
  thead.appendChild(tr3);
}

function appendSummaryRow(label, sums, tbody, isTotal = false) {
  if (!Array.isArray(sums)) {
    console.error("üìõ appendSummaryRow: sumsÍ∞Ä Î∞∞Ïó¥Ïù¥ ÏïÑÎãò!", sums);
    return;
  }

  const tr = document.createElement("tr");
  tr.className = isTotal ? "total-row" : "subtotal-row";

  // ‚úÖ Ïïû Îëê Ïπ∏: ÏÜåÍ≥Ñ/Ï¥ùÍ≥Ñ ÎùºÎ≤®, Ïù∏ÏõêÏàòÎäî ÏÉùÎûµ
  tr.innerHTML = `
    <td class="weekly-type-cell" colspan="2">${label}</td>
  `;

  // ‚úÖ ÏöîÏùºÎ≥Ñ Ï°∞/Ï§ë/ÏÑù Ïù∏ÏõêÎßå Ï∂úÎ†• (Î™ÖÎã® Ï†úÏô∏)
  sums.forEach((day) => {
    tr.innerHTML += `
      <td class="weekly-count-cell">${day.b || 0}</td>
      <td class="weekly-count-cell">-</td>  <!-- Î™ÖÎã® ÏóÜÏùå -->
      <td class="weekly-count-cell">${day.l || 0}</td>
      <td class="weekly-count-cell">${day.d || 0}</td>
      <td class="weekly-count-cell">-</td>  <!-- Î™ÖÎã® ÏóÜÏùå -->
    `;
  });

  tbody.appendChild(tr);
}

function setDefaultWeeklyDate() {
  const today = getKSTDate();
  const monday = getMonday(today);
  const yyyy = monday.getFullYear();
  const mm = String(monday.getMonth() + 1).padStart(2, "0");
  const dd = String(monday.getDate()).padStart(2, "0");
  document.getElementById("weeklyBaseDate").value = `${yyyy}-${mm}-${dd}`;
}

function downloadWeeklyDeptExcel() {
  const base = document.getElementById("weeklyBaseDate").value;
  if (!base) return alert("Í∏∞Ï§Ä ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
  const range = getWeeklyDateRange(base);
  const start = range[0];
  const end = range[range.length - 1];

  showToast("üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ÄÎπÑ Ï§ë...");
  window.location.href = `${API_BASE_URL}/admin/stats/weekly_dept/excel?start=${start}&end=${end}`;
}